# **【練習問題】Debt Default Risk Reduction - Predicting Loan Repayment Status**

## **プロジェクト概要 (Project Overview)**
このプロジェクトでは、顧客データ（借入総額、返済期間、金利、借入目的など）を活用して、債務不履行リスクを予測するモデルを構築しました。目的は、リスクの高い顧客を特定し、債務不履行を未然に防ぐ方法を見出すことです。

### **プロジェクトの目的**
「債務不履行リスクの低減」を目的とし、以下を実現する予測モデルを開発しました。
- 顧客のローン返済状況（完済または債務不履行）の予測
- 予測結果に基づいた、リスク管理およびビジネス改善の提案

### **評価指標**
- **F1スコア**  
  現在のスコア: **0.415**
- コンペティション順位: **523人中39位**（上位10%）

### **使用データ**
- **説明変数（特徴量）**  
  - `loan_amnt`: 借入総額  
  - `term`: 返済期間  
  - `interest_rate`: 金利  
  - `purpose`: 借入目的  
  - その他、計9特徴量

- **目的変数**  
  - `0`: Fully Paid（完済）  
  - `1`: Charged Off（債務不履行）

## **データ概要とEDAのインサイト (Data Overview and EDA Insights)**

### **データの特徴**
- **サンプル数**: 242,156
- **欠損値**: `employment_length` に欠損値あり
- **目的変数の分布**:
  - **完済 (Fully Paid)**: 80%
  - **債務不履行 (Charged Off)**: 20%

### **目的変数の分布**
![Distribution of Target Variable](images/1.distribution_target.png)

債務不履行（`1`）は全データの約20%を占めています。このため、モデル構築時にはクラスの不均衡を考慮する必要があります。

## **主なEDA結果とインサイト (Key EDA Results and Insights)**

### **1. Interest Rate（金利）と Credit Score（クレジットスコア）の関係**
![Interest Rate by Credit Score](images/2.interest_credit_score.png)

- **クレジットスコアが低いほど金利が高い**
  - 金融業界の一般的なルールを反映しています。リスクの高い借り手（クレジットスコアが低い）は、より高い金利を課される傾向にあることが確認できます。

- **クレジットスコアが800以上の場合、金利の変動が少ない**
  - クレジットスコアが800を超える場合、金利の中央値がほぼ一定で、レンジも狭くなっています。このことから、信用度の高い借り手が優遇される傾向が見られます。

- **金利のばらつきが大きいスコア帯**
  - 特にクレジットスコアが660～700の範囲では、金利のばらつきが広いことが確認できます。これは、このスコア帯に属する借り手が多様な信用リスクプロファイルを持っているためと推測されます。

- **異常値の観察**
  - ボックスプロット上部の外れ値（特にスコアが高い場合でも金利が異常に高いもの）に注目することで、新たなインサイトを得られる可能性があります。例: 特殊な借入条件や目的が影響している可能性。

---

### **追加の考察**
1. **政策変更や金融商品への影響**
   - クレジットスコアと金利の関係を基に、スコアの境界値（例: 700や800）をターゲットにした特別な融資プランを作成することで、債務不履行リスクを抑える施策が提案できます。

2. **リスク予測モデルへの活用**
   - クレジットスコアと金利の相関をモデルの重要な特徴量として活用することで、より精度の高い債務不履行リスクの予測が可能になります。

---

### **2. Total Payment と Loan Status の関係**
![Distribution of Total Payment by Loan Status](images/3.total_payment_loan_status.png)

#### **インサイト**
1. **Total Payment が低い場合のリスク**
   - **$1,000以下**の総支払額の場合、債務不履行の割合は非常に低い。
   - 小額借入者は返済能力に問題がない傾向が見られる。

2. **$5,000以上の高額借入のリスク増加**
   - 総支払額が**$5,000以上**になると、債務不履行の割合が急激に増加。
   - 高額借入者にはリスクが高まり、追加の審査や保証条件が必要と考えられる。

3. **債務不履行者の分布**
   - 債務不履行者は広範囲の借入額で確認されるが、特に**$5,000以上**の高額借入で集中している。
   - この傾向から、貸付額の上限を再検討する必要がある可能性が示唆される。

---

#### **提案**
1. **小額ローンの審査基準を簡略化**
   - **$1,000以下**の借入額に対して、審査基準を簡略化することで、顧客体験を向上させ、取引量の増加を目指す。

2. **高額借入者向けの追加保証**
   - **$5,000以上**の借入額に対して、以下を追加検討:
     - 担保の提供
     - 収入証明書の提出

3. **貸付額の上限を調整**
   - 高額借入のリスクを軽減するため、最大貸付額を調整し、健全な貸付ポートフォリオを維持する。

---

### **3. Monthly Payment と Loan Status の関係**
![Distribution of Monthly Payment by Loan Status](images/4.monthly_payment_loan_status.png)

#### **インサイト**
1. **低額月々支払い（$25以下）の債務不履行リスク**
   - 月々の支払額が**$25以下**の場合、債務不履行の割合が非常に低い。
   - 低額借入者はリスクが少なく、返済能力が比較的高いと推測される。

2. **中額月々支払い（$25〜$100）の債務不履行の割合**
   - 支払額が**$25〜$100**の範囲では、債務不履行の割合が徐々に増加している。
   - この範囲では、顧客の支払い能力が徐々に限界に近づいている可能性がある。

3. **高額月々支払い（$100以上）のリスク急増**
   - 月々の支払額が**$100を超える**と、債務不履行の割合が急激に増加。
   - 高額返済者の約**50%**が不履行のリスクを抱えている。

4. **右尾の分布（$150以上）**
   - ごく少数のケースだが、極端に高額な月々支払額を持つ借入者はさらに高いリスクを示す。
   - 特別な支援策が必要とされる。

---

#### **提案**
1. **低額ローンの審査基準を緩和**
   - **$25以下**のローンに対して審査基準を緩和することで、リスクの少ない新規顧客の獲得を促進。

2. **教育的アプローチ**
   - **$25〜$100**の範囲の顧客に対して、返済計画の相談やアドバイスを提供。
   - データ駆動型の早期警告システムを導入し、債務不履行を予防。

3. **高額ローンへの追加審査**
   - **$100以上**の支払額を持つ借入者に対して、以下の追加審査を検討:
     - 収入証明書の提出
     - 担保提供の義務化

4. **柔軟な返済プランの提供**
   - 極端に高額な月々支払額を持つ顧客に対して、以下を提案:
     - 返済期間の延長
     - 分割支払額の減額

---

#### **ステークホルダーへの提案**
1. **審査基準の再設計**
   - 支払額が**$100以上**となる借入者に対し、リスク評価を強化。
   - 例: 顧客の信用スコアや収入データを基にしたリスクモデルの導入。

2. **リスク緩和策**
   - 高額ローンの顧客には、柔軟な返済プランを提供して債務不履行を防止。

3. **低リスク層の拡大**
   - **$25以下**の顧客基盤を拡大することで、ポートフォリオ全体のリスクを分散。

---

### **4. Credit Score と Loan Status の関係**
![Distribution of Credit Score by Loan Status](images/5.credit_score_loan_status.png)

#### **インサイト**
1. **リスク管理の優先対象**
   - **クレジットスコア750以下**の層では、債務不履行の可能性が高まる傾向が見られます。
   - 特にスコアが**650〜700**の層はリスクが顕著であり、重点的なモニタリングが必要です。

2. **低リスク層の活用**
   - **クレジットスコア750以上**の借り手は、債務不履行の割合が非常に低い低リスク層です。
   - この層への貸付を増やすことで、全体のポートフォリオリスクを低減可能。

3. **スコア分布を利用した新商品開発**
   - スコア分布に基づき、異なる条件を設定したローン商品（例: リスクに応じた金利や返済期間）を提供することで、ターゲット層を拡大可能。

---

#### **提案**
1. **リスクアセスメント強化**
   - **スコア650〜700**の層に対して、事前のリスクアセスメントを強化。
   - 審査プロセスを厳密化し、債務不履行リスクを軽減。

2. **高スコア層への優遇**
   - **スコア750以上**の高スコア層には、優遇金利や特別条件を提供することで、優良顧客の獲得を促進。

3. **スコア分布を考慮した商品戦略**
   - **750以下の借り手**:
     - 厳しい審査基準や保証条件を設定。
   - **750以上の借り手**:
     - リスクの低さを活用したローンキャンペーンを展開。
   - スコア分布を活用し、顧客のリスクプロファイルごとに差別化した商品を開発。

---



********************************************************************


5. Burden Index(負担指数）とLoan statusの関係：

![Burden Index by Loan status](images/9.burden_index_loan_status.png)

Burden Index（負担指数）は、借り手が負担する返済の重さや負担感を数値化する指標です。

通常、借り手の返済能力やローンの健全性を評価する際に利用されます。

#### 負担指数が2を超えると、債務不履行が急増

負担指数が2を超えると、完済（loan_status=0）の割合が急激に減少し、債務不履行（loan_status=1）の割合が目立って増加します。

解釈: 借り手の返済負担が過剰になると、返済能力が追いつかず、債務不履行に陥るリスクが高まる。

#### 負担指数が2未満の借り手はリスクが低い

負担指数が2未満では、債務不履行の割合が非常に低く、この層は安定した返済能力を持つことを示しています。

解釈: この層は低リスクであり、金融機関にとって安心して融資可能な顧客群と言えます。

#### 負担指数が極端に高い層（6以上）は非常に少ないがリスクが最も高い

負担指数が6以上では、債務不履行がほぼ確実に起こるため、事実上、リスクが極めて高い顧客層とみなされます。

提案:審査基準の見直し

負担指数が2を超える層に対して、追加の審査基準を設定

例: 借入時の収入証明書や資産証明の提出を必須とし、返済能力を正確に評価する。

#### 柔軟な返済プランの提供

高負担指数（2以上）の借り手には、分割返済や返済期間の延長などの柔軟なプランを提案

これにより、返済負担を軽減し、債務不履行のリスクを低減。

#### リスクが低い層へのプロモーション

負担指数が2未満の借り手に対し、優遇金利や特別なローン条件を提供することで、優良顧客を増やしつつ、ポートフォリオ全体のリスクを抑える。

#### リスク層の教育と支援

高負担指数（2以上）の層に対し、返済計画や家計管理に関する教育プログラムを提供。

顧客が返済負担を正しく認識し、適切に対応できるよう支援。

提案：

負担指数が2を超える借り手には、追加の審査基準や柔軟な返済プランを提案することで、債務不履行のリスクを軽減できます。

一方、負担指数が2未満の層には優遇金利を適用し、優良顧客層を拡大することが可能です。

負担指数が6以上の極端な高リスク層には、融資条件を大幅に厳格化するか、融資を制限する方針が推奨されます。


6. Loan AmountとMonthly paymentの正の相関：

![Loan Amount by Monthly Payment](images/11.scatterplot_loanAmount_monthlyPayment.png)

借入額が増加するほど、月々の支払額も増加しています。

解釈: 借入額と月々の支払額は当然ながら強い正の相関があり、ローン契約における基本的なルールを反映しています。

#### 債務不履行（Charged Off）の分布

高い月々の支払額（約100以上）や高い借入額（約3000以上）の領域 で、債務不履行（赤い点）が増加しています。

解釈: 借り手の負担が大きくなると、返済が難しくなる傾向があることを示しています。

#### 低い借入額・支払額領域の安定性

借入額が1000以下、月々の支払額が50以下の範囲では、完済（青い点）がほとんどを占めています。

解釈: 小額ローンはリスクが低く、完済される可能性が高いです。

#### 債務不履行が集中する傾向

中程度の借入額（1500〜2500）でも、高い月々の支払額（100以上）の場合、債務不履行の割合が上昇しているように見えます。

解釈: 支払額の高さが債務不履行の主な要因である可能性が高いです。

提案:高額ローンのリスク管理

借入額が高いローン（3000以上）に対して、審査基準を厳格化する。

高額ローンに対しては、柔軟な返済期間や金利設定を提供することで、負担を軽減し、債務不履行を防止。

#### 支払額の上限設定

月々の支払額が100を超えるローンには、追加のリスク評価を行う。

借り手の収入や負担指数（Burden Index）を考慮したプランを導入。

#### 小額ローンの拡大

借入額が1000以下、支払額が50以下のローンが安定的に完済されることを踏まえ、このセグメントの拡大を検討。

低リスク層へのキャンペーンや優遇金利を提供。


7. Burden IndexとMonthly paymentの関係：

![Burden Index by Monthly Payment](images/12.scatterplot_burdenIndex_MonthlyPayment.png)

#### 返済期間による明確なクラスター

図は、返済期間36ヶ月と60ヶ月のクラスターが明確に分かれていることを示しています。

解釈: 同じ負担指数（Burden Index）でも、返済期間が長い場合（60ヶ月）は月々の支払額が低く抑えられています。

一方で、返済期間が短い場合（36ヶ月）は月々の支払額が高くなります。

#### 債務不履行の集中領域

どちらの返済期間でも、負担指数が高い領域（Burden Index > 4）で債務不履行（Charged Off, 赤い点）の割合が増加しています。

特に、返済期間が36ヶ月で月々の支払額が高い層に、不履行が集中していることが確認できます。

解釈: 短期の高額返済は、借り手にとって負担が大きく、債務不履行のリスクを高める要因となっています。

#### 完済層の安定性

負担指数が低い（Burden Index < 2）層では、ほとんどが完済（Fully Paid, 青い点）されています。

解釈: 返済計画が借り手の返済能力に適していれば、不履行のリスクを抑えられることを示しています。

提案: 返済期間の柔軟性の提供

高額ローンや高い負担指数の借り手に対しては、返済期間を60ヶ月以上に延長するプランを提供することで、月々の支払額を軽減し、不履行リスクを低減できます。

#### 負担指数に基づく審査強化

Burden Index > 4 の層に対して、より厳格な審査基準を導入する。

例: 収入証明や信用スコアの詳細確認を必須化。

#### リスクの高い短期ローンへの注意

返済期間が36ヶ月で負担指数が高い借り手には、返済能力に応じた分割プランの提案やローン金額の調整を推奨。

#### リスクの低い借り手層へのプロモーション

負担指数が低い層（Burden Index < 2）に対し、優遇金利や特別プランを提供し、安定した収益源を拡大。

#### 教育プログラムの提供

高負担指数の借り手に対し、返済計画や家計管理についてのアドバイスを提供することで、債務不履行のリスクを軽減。


### 前処理**
#### 1. employment_length の前処理
employment_length 列は、借り手の勤務年数を表す特徴量です。この列は文字列型なので、数値型の特徴量として利用するには以下のような変換が必要でした：

"10 years" や "2 years" の文字列部分（years や year）を削除し、純粋な数値に変換。
"< 1 year" を特別に扱い、0 に変換。
NaN（欠損値）はそのまま保持して、後続の処理やモデルで適切に扱えるようにする。
これを実現するために処理関数 process_employment_length を定義しました：

正規表現の使用理由:
'years' や 'year' を削除する処理を一貫して簡潔に記述するために使用しました。
'< 1' を特別に置き換える処理も正規表現を用いて効率化しています。

#### 2. term の前処理
term 列は、ローンの返済期間（例："36 years"）を表しています。この列も文字列型で提供されており、数値型に変換する必要がありました。

そこで、以下のような処理を行いました：

"years" の部分を削除。
結果を数値型（float）に変換。
もし値が欠損値（NaN）であれば、そのまま保持。
これを実現するために、apply 関数と正規表現を使用しました：

正規表現の使用理由:
"years" を一括して削除し、前後の空白を除去するため。
欠損値をそのまま扱うための isinstance(x, str) チェックを追加。

### なぜこの処理が必要か
機械学習モデルは数値型データを扱う:

lightGBMはemployment_length や term のようなobjectデータをカテゴリ型として明示することで、トレーニング可能です。今回は数値型に変換しています。

欠損値（NaN）の保持:

欠損値を削除せずに保持することで、モデルがその特徴を自分で考慮できるようにしました。LightGBM のようなツリーベースのモデルは NaN を直接扱えるため、この選択を採用しました。

データの一貫性と精度の向上:

文字列データを統一し、で数値型に変換することで、分析やモデルのトレーニング時にエラーが発生しないようにしました。

#### 3. interest_rate の正規化
interest_rate 列は、ローンの利率を示す特徴量で、パーセント形式で提供されています（例: 5.5, 12.75）。しかし、モデルでは小数形式（0.055, 0.1275）の数値型に変換するほうがより理解しやすくなるのではと考えました。

理由:

パーセント表記は人間にとって分かりやすいものですが、数値として扱う際には小数形式にすることで直接的な計算が可能になります。
正規化により、モデルのスケーリングや学習効率の改善を期待しました。

#### 4. grade のラベルエンコーディング
grade 列は、借り手の信用格付けを示すカテゴリカルデータです（例: A, B, C）。機械学習モデルで直接扱うには、数値に変換する必要があります。そのため、ラベルエンコーディングを適用しました。

理由:

数値に変換することで、モデルがこの特徴量を直接扱えるようになります。
ラベルエンコーディングを使用する場合、カテゴリ間に順序がある（例えば、A > B > C のような信用格付けの優劣）ことを前提としています。

#### 5. 月利と返済回数の計算
interest_rate（年利）と term（ローン期間）が与えられているため、月利と返済回数を計算しました。
ローンの毎月の返済額は以下の式で計算されます（元利均等返済）：

![元利均等返済](images/repayment.png)

ポイント:

月利が0の場合: 元金を返済期間で均等に割る単純な計算に切り替えています。

この柔軟な実装により、データ内で特殊な状況にも対応可能です。

#### ​6. 負担指数（burden_index）の計算
burden_index（返済負担指数）は、借り手の返済負担を評価するために'total_payment'を'credit_score'で割って計算しました。

計算意図:

借り手の credit_score（信用スコア）に対して、総返済額を比較することで、返済の負担感を定量化します。
負担指数が高いほど、借り手にとって返済が負担となる可能性が高いと推測できます。

###　数値変数の相関関係

![Correlation_matrix](images/10.correlation_matrix.png)

 
### **使用したモデルと手法**
1. モデル構築
LightGBM

F1スコア: 0.4153864

CatBoost

F1スコア: 0.4115399

2. パラメータチューニング
Optuna を使用して、最適なパラメータを探索。

3. クロスバリデーション
Stratified K-Fold（5分割）を適用し、モデルの汎化性能を確認。
 
### **precision、Recall　and F1 score by Threshold**

![lightGBM_feature_importance](images/14.f1_score.png)


### **今後の課題と改善点**
- **モデルの精度向上**:

CatBoostの結果を確認し、LightGBMとのアンサンブルを検討しましたが、思うような改善は見られませんでした。

- **特徴量エンジニアリング**:

勤務年数とローン年数を合計し、新しい特徴量を作成しました。

- **モデル解釈**:
Permutation Importanceを用いて、特徴量の重要度を可視化。

![lightGBM_feature_importance](images/13.lightGBM_feature_importance.png)

### **環境構築**
Python: 3.8

pip install pandas numpy matplotlib seaborn lightgbm catboost optuna scikit-learn

### **まとめ**
本プロジェクトでは、顧客の債務不履行リスクを予測するためにEDAとLightGBM、CatBoostを活用しました。
現在のF1スコアはlightGBMで 0.4153864です。 次にCatBoostの結果を踏まえ、さらなる精度改善を目指します。
