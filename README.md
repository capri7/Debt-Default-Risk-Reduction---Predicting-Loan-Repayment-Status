# Debt Default Risk Reduction - Predicting Loan Repayment Status

**【練習問題】債務不履行リスクの低減**  
借入総額や返済期間、金利、借入目的などの顧客データを使って、債務不履行リスクを予測するモデルを構築しました。

---

## プロジェクト概要 (Introduction)

### **概要**
本プロジェクトは「**債務不履行リスクの低減**」を目的とし、与えられた顧客データを用いて、**債務が完済されるかどうか**を予測します。

- **評価指標**: F1スコア  
- **現在の成績**: 523人中 **39位(上位10%以内）**  

### **使用データ**
- **説明変数**:  
   - `loan_amnt`: 借入総額  
   - `term`: 返済期間  
   - `interest_rate`: 金利  
   - `purpose`: 借入目的  
   - その他、計9特徴量  
- **目的変数**:  
   - `0`: Fully Paid（完済）  
   - `1`: Charged Off（債務不履行）

### **データ概要とEDAのインサイト**
- **データの特徴**
   - サンプル数: 242,156  
   - 欠損値: employment_length に欠損値 
   - データ分布:   
   - 目的変数の分布:
   - - 完済: 80% 
   - - 債務不履行: 20%

![目的変数の分布](images/1.distribution_target.png)

債務不履行（1）は全データの約20%を占めるため、クラスの不均衡を考慮する必要があります。

### **主なEDA結果とインサイト**
1. interest_rateとcredit_scoreの関係：

![金利とクレジットスコア](images/2.interest_credit_score.png)

#### クレジットスコアが低いほど金利が高い

これは金融業界の一般的なルールを反映しており、リスクが高い借り手（クレジットスコアが低い）は、より高い金利を課される傾向にあることを確認できます。

#### クレジットスコアが800以上の場合、金利の変動が少ない

クレジットスコアが800を超える場合、金利の中央値がほぼ一定で、レンジも狭くなっていることから、非常に信用度の高い借り手が優遇される傾向があると推測されます。

#### 金利のばらつきが大きいスコア帯

特にクレジットスコアが660～700の範囲では、金利のばらつきが広いことが確認できます。これは、このスコア帯に属する借り手が多様な信用リスクプロファイルを持っているためと考えられます。

#### 異常値の観察

ボックスプロット上部の外れ値（特にスコアが高い場合でも金利が異常に高いもの）に注目し、その背景を調査することで、新たなインサイトを得られる可能性があります（例: 特殊な借入条件や目的が影響している）。

### 追加の考察
#### 政策変更や金融商品への影響
クレジットスコアと金利の関係を基に、スコアの境界値（例: 700や800）をターゲットにした特別な融資プランを作成することで、債務不履行リスクを抑える施策が提案できるかもしれません。

#### リスク予測モデルへの活用
クレジットスコアと金利の相関をモデルの重要な特徴量として活用することで、より精度の高い債務不履行リスクの予測が可能になると考えられます。

2. Total paymentとLoan statusの関係：

![Total payment by Loan status](images/3.total_payment_loan_status.png)

#### Total Paymentが低い場合のリスク

Total Paymentが$1,000以下の場合、債務不履行の割合は非常に低い。

小額借入者は、返済能力に問題がない傾向がある。

提案: 小額ローンの審査基準を簡略化し、顧客体験を向上させることで取引量を増加できる可能性があります。

#### $5,000以上の高額借入のリスク増加

$5,000以上の借入額では、債務不履行の割合が急激に増加。
高額借入者にはリスクが高まるため、さらなる審査や保証条件が必要。

提案: 高額借入者向けに追加保証（例: 担保、収入証明書の提出）を義務付ける。

#### 債務不履行者の分布

債務不履行者は、広範囲の借入額で確認されるが、高額借入で集中。

特に$5,000以上で顕著に見られるため、貸付額の上限を再検討する必要がある可能性あり。

提案: 最大貸付額を調整することで、リスクを軽減し、健全な貸付ポートフォリオを維持する。


3. Monthly paymentとLoan statusの関係：

![monthly_payment payment by Loan status](images/4.monthly_payment_loan_status.png)

#### 低額月々支払い（$25以下）の債務不履行リスク

月々の支払額が低い（$25以下）場合、債務不履行の割合が非常に低いことが確認できます。

提案: 低額ローンの審査基準を緩和し、顧客へのローン提供を促進することで、新規顧客獲得を目指せます。

#### 中額月々支払い（$25〜$100）の債務不履行の割合

支払額が$25〜$100の範囲では、債務不履行の割合が徐々に増加しています。

提案: この範囲のローン契約者に対して、教育的なアプローチ（例: 返済計画の相談や予防策のアドバイス）を行うことで、リスクを軽減できます。

#### 高額月々支払い（$100以上）のリスク急増

月々の支払額が$100を超えると、債務不履行の割合が急激に増加し、約50%に達します。

提案: 高額ローンの契約時に、追加の審査基準（収入証明や担保提供など）を設けることで、不履行リスクを抑制できます。

#### 右尾の分布（$150以上）

ごく少数ですが、極端に高い月々支払額を持つ借入者は、不履行のリスクがさらに高い可能性があります。

提案: 高額返済者に対して、柔軟な返済プラン（分割返済や期間延長）を提供し、支払い負担を軽減する施策を導入します。

### ステークホルダーへの提案

#### 審査基準の再設計

支払額が$100以上となる借入者に対し、より厳格なリスク評価を導入する。

例: 顧客の信用スコアや収入の詳細を分析し、返済能力を正確に見積もる。

#### リスク緩和策

高額ローンの債務不履行リスクを軽減するために、柔軟な返済プランを提供（例: 返済期間の延長、分割支払額の減額）。

#### 低リスク層の拡大

$25以下の低額支払い層の顧客基盤を拡大することで、低リスクのポートフォリオを構築。

#### データ駆動型の顧客支援

中額支払い層（$25〜$100）の顧客に対して、早期警告システムを構築し、債務不履行を予防する。

4. Credit scoreとLoan statusの関係：

![Credit_score by Loan status](images/5.credit_score_loan_status.png)

#### リスク管理の優先対象

クレジットスコア750以下の層では、債務不履行の可能性が高まるため、この層を重点的にモニタリングすることが重要です。

提案: 特にスコア650〜700の層に対し、事前のリスクアセスメントを強化する。

#### 低リスク層の活用

クレジットスコア750以上の借り手は低リスクであり、この層への貸付を増やすことで、全体のポートフォリオリスクを低減できます。

提案: 高スコア層に優遇金利を提供することで、優良顧客を引きつける戦略を検討。

#### スコアの分布を利用した新商品開発

スコア分布を考慮し、スコア別に異なる条件を設定したローン商品（例: リスクに応じた金利や返済期間）を提供する。

提案:

クレジットスコア750以下の借り手には、より厳しい審査基準や保証条件を設定する。

高スコア層（750以上）には、リスクが低いことを踏まえたローンキャンペーンを展開する。

スコア分布を活用して、リスクプロファイルごとに差別化した商品を開発する。

5. Burden Index(負担指数）とLoan statusの関係：

![Burden Index by Loan status](images/9.burden_index_loan_status.png)

Burden Index（負担指数）は、借り手が負担する返済の重さや負担感を数値化する指標です。

通常、借り手の返済能力やローンの健全性を評価する際に利用されます。

プロットから負担指数が2を超えると完済できる人の数が急激に減っています。

#### 負担指数が2を超えると、債務不履行が急増

負担指数が2を超えると、完済（loan_status=0）の割合が急激に減少し、債務不履行（loan_status=1）の割合が目立って増加します。

解釈: 借り手の返済負担が過剰になると、返済能力が追いつかず、債務不履行に陥るリスクが高まる。

#### 負担指数が2未満の借り手はリスクが低い

負担指数が2未満では、債務不履行の割合が非常に低く、この層は安定した返済能力を持つことを示しています。

解釈: この層は低リスクであり、金融機関にとって安心して融資可能な顧客群と言えます。

#### 負担指数が極端に高い層（6以上）は非常に少ないがリスクが最も高い

負担指数が6以上では、債務不履行がほぼ確実に起こるため、事実上、リスクが極めて高い顧客層とみなされます。

提案:審査基準の見直し

負担指数が2を超える層に対して、追加の審査基準を設定

例: 借入時の収入証明書や資産証明の提出を必須とし、返済能力を正確に評価する。

#### 柔軟な返済プランの提供

高負担指数（2以上）の借り手には、分割返済や返済期間の延長などの柔軟なプランを提案

これにより、返済負担を軽減し、債務不履行のリスクを低減。

#### リスクが低い層へのプロモーション

負担指数が2未満の借り手に対し、優遇金利や特別なローン条件を提供することで、優良顧客を増やしつつ、ポートフォリオ全体のリスクを抑える。

#### リスク層の教育と支援

高負担指数（2以上）の層に対し、返済計画や家計管理に関する教育プログラムを提供。

顧客が返済負担を正しく認識し、適切に対応できるよう支援。

提案：

負担指数が2を超える借り手には、追加の審査基準や柔軟な返済プランを提案することで、債務不履行のリスクを軽減できます。

一方、負担指数が2未満の層には優遇金利を適用し、優良顧客層を拡大することが可能です。

負担指数が6以上の極端な高リスク層には、融資条件を大幅に厳格化するか、融資を制限する方針が推奨されます。

6. Burden Index(負担指数）とLoan statusの関係：

![Burden Index by Loan status](images/9.burden_index_loan_status.png)


### 前処理**
#### 1. employment_length の前処理
employment_length 列は、借り手の勤務年数を表す特徴量です。この列は文字列型なので、数値型の特徴量として利用するには以下のような変換が必要でした：

"10 years" や "2 years" の文字列部分（years や year）を削除し、純粋な数値に変換。
"< 1 year" を特別に扱い、0 に変換。
NaN（欠損値）はそのまま保持して、後続の処理やモデルで適切に扱えるようにする。
これを実現するために処理関数 process_employment_length を定義しました：

正規表現の使用理由:
'years' や 'year' を削除する処理を一貫して簡潔に記述するために使用しました。
'< 1' を特別に置き換える処理も正規表現を用いて効率化しています。

#### 2. term の前処理
term 列は、ローンの返済期間（例："36 years"）を表しています。この列も文字列型で提供されており、数値型に変換する必要がありました。

そこで、以下のような処理を行いました：

"years" の部分を削除。
結果を数値型（float）に変換。
もし値が欠損値（NaN）であれば、そのまま保持。
これを実現するために、apply 関数と正規表現を使用しました：

正規表現の使用理由:
"years" を一括して削除し、前後の空白を除去するため。
欠損値をそのまま扱うための isinstance(x, str) チェックを追加。

### なぜこの処理が必要か
機械学習モデルは数値型データを扱う:

lightGBMはemployment_length や term のようなobjectデータをカテゴリ型として明示することで、トレーニング可能です。今回は数値型に変換しています。

欠損値（NaN）の保持:

欠損値を削除せずに保持することで、モデルがその特徴を自分で考慮できるようにしました。LightGBM のようなツリーベースのモデルは NaN を直接扱えるため、この選択を採用しました。

データの一貫性と精度の向上:

文字列データを統一し、で数値型に変換することで、分析やモデルのトレーニング時にエラーが発生しないようにしました。

#### 3. interest_rate の正規化
interest_rate 列は、ローンの利率を示す特徴量で、パーセント形式で提供されています（例: 5.5, 12.75）。しかし、モデルでは小数形式（0.055, 0.1275）の数値型に変換するほうがより理解しやすくなるのではと考えました。

理由:

パーセント表記は人間にとって分かりやすいものですが、数値として扱う際には小数形式にすることで直接的な計算が可能になります。
正規化により、モデルのスケーリングや学習効率の改善を期待しました。

#### 4. grade のラベルエンコーディング
grade 列は、借り手の信用格付けを示すカテゴリカルデータです（例: A, B, C）。機械学習モデルで直接扱うには、数値に変換する必要があります。そのため、ラベルエンコーディングを適用しました。

理由:

数値に変換することで、モデルがこの特徴量を直接扱えるようになります。
ラベルエンコーディングを使用する場合、カテゴリ間に順序がある（例えば、A > B > C のような信用格付けの優劣）ことを前提としています。

#### 5. 月利と返済回数の計算
interest_rate（年利）と term（ローン期間）が与えられているため、月利と返済回数を計算しました。
ローンの毎月の返済額は以下の式で計算されます（元利均等返済）：


<img src="repayment.png" alt="元利均等返済" width="600">


ポイント:

月利が0の場合: 元金を返済期間で均等に割る単純な計算に切り替えています。

この柔軟な実装により、データ内で特殊な状況にも対応可能です。

#### ​6. 負担指数（burden_index）の計算
burden_index（返済負担指数）は、借り手の返済負担を評価するために'total_payment'を'credit_score'で割って計算しました。

計算意図:

借り手の credit_score（信用スコア）に対して、総返済額を比較することで、返済の負担感を定量化します。
負担指数が高いほど、借り手にとって返済が負担となる可能性が高いと推測できます。

###　数値変数の相関関係

6. 数値変数の相関図：

![Correlation_matrix](images/10.correlation_matrix.png)

 
### **使用したモデルと手法**
1. モデル構築
LightGBM

F1スコア: 0.4153864

CatBoost

F1スコア: 0.4115399

2. パラメータチューニング
Optuna を使用して、最適なパラメータを探索。

3. クロスバリデーション
Stratified K-Fold（5分割）を適用し、モデルの汎化性能を確認。
 
### **結果の可視化**
- **重要な可視化結果**:
Burden Index と Monthly Payment:
Loan Amount と Monthly Payment:

- **目的変数の分布**:

### **今後の課題と改善点**
- **モデルの精度向上**:

CatBoostの結果を確認し、LightGBMとのアンサンブルを検討しましたが、思うような改善は見られませんでした。

- **特徴量エンジニアリング**:

勤務年数とローン年数を合計し、新しい特徴量を作成しました。

- **モデル解釈**:
Permutation Importanceを用いて、特徴量の重要度を可視化。

### **環境構築**
Python: 3.8

pip install pandas numpy matplotlib seaborn lightgbm catboost optuna scikit-learn

### **まとめ**
本プロジェクトでは、顧客の債務不履行リスクを予測するためにEDAとLightGBM、CatBoostを活用しました。
現在のF1スコアは 0.4153864です。 CatBoostの結果を踏まえ、さらなる精度改善を目指します。
